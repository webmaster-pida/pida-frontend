<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIDA | Plataforma de Investigación y Defensa Avanzada</title>

	<link rel="icon" type="image/png" href="/img/favicon.png">

	<!-- =========================================================================
     Etiquetas Open Graph para Redes Sociales (WhatsApp, Facebook, LinkedIn)
     ========================================================================= -->
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://pida-ai.com/" />
	<meta property="og:title" content="PIDA" />
	<meta property="og:description" content="Plataforma de Investigación y Defensa Avanzada." />
	<meta property="og:image" content="https://pida-ai.com/img/PIDA-MASCOTA-Trans-menu-peq.png" />

	<!-- Configuración extra para Twitter/X -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content="PIDA" />
	<meta name="twitter:description" content="Plataforma de Investigación y Defensa Avanzada" />
	<meta name="twitter:image" content="https://pida-ai.com/img/PIDA-MASCOTA-Trans-menu-peq.png" />
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-functions-compat.js"></script>

    <style>
        /* =========================================
           LOADER DE TRANSICIÓN GLOBAL (MODIFICADO)
           ========================================= */
        #pida-global-loader {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FFFFFF; /* CAMBIO: Fondo Blanco */
            z-index: 9999999999; /* Máxima prioridad */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease, visibility 0.6s;
        }
        #pida-global-loader.fade-out { opacity: 0; visibility: hidden; pointer-events: none; }
        
        /* Animación para la imagen del loader */
        .loader-mascot-img {
            width: 150px; height: auto;
            animation: pulse-logo 2s infinite ease-in-out;
        }

        @keyframes pulse-logo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.95); opacity: 0.8; } }

        /* =========================================
           ESTILOS DEL BANNER DE SISTEMA
           ========================================= */
        .system-banner { position: fixed; top: 0; left: 0; width: 100%; background-color: #ff9800; color: white; text-align: center; padding: 12px 20px; z-index: 999999999; font-family: 'Inter', sans-serif; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; }
        .system-banner.hidden { display: none !important; }
        .system-banner strong { font-weight: 800; margin-right: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .system-banner button { background: none; border: none; color: rgba(255,255,255,0.8); font-size: 1.5rem; cursor: pointer; font-weight: bold; margin-left: 20px; line-height: 1; padding: 0 5px; }
        .system-banner button:hover { color: white; }

        /* =========================================
           1. ESTILOS DE LA LANDING PAGE
           ========================================= */
        :root {
            --navy: #1d3557; --pidared: #b92f32; --navy-dark: #ffffff; --cyan: #1d3557; --cyan-glow: rgba(0, 195, 255, 0.4);
            --red: #FF3366; --white: #FFFFFF; --gray-subtle: #F9FAFB; --border-light: #E5E7EB;
            --font-display: 'Open Sans', sans-serif; --font-body: 'Manrope', sans-serif;
            --pida-primary: #1D3557; --pida-accent: #0056B3; --pida-bg-app: #F4F6F9;
            --pida-bg-white: #FFFFFF; --pida-text-main: #1F2937; --pida-text-muted: #6B7280;
            --pida-border: #E5E7EB; --pida-font: 'Inter', sans-serif;
        }

		img {
    			max-width: 100%;
    			height: auto;
    			display: block; /* Ayuda a evitar espacios fantasma debajo de las imágenes */
			}

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { background-color: var(--white); color: var(--navy); font-family: var(--font-body); line-height: 1.6; overflow-x: hidden; -webkit-font-smoothing: antialiased; transition: margin-top 0.3s ease; }
        h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 700; line-height: 1.1; letter-spacing: -0.03em; }
        .wrapper { max-width: 1200px; margin: 0 auto; padding: 0 24px; position: relative; }
        .text-gradient { background: linear-gradient(135deg, var(--navy) 0%, #b92f32 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .label { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--cyan); margin-bottom: 12px; display: inline-block; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 24px; font-weight: 600; font-size: 0.95rem; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; gap: 8px; text-decoration: none;}
        .btn-primary { background-color: var(--navy); color: var(--white); border: 1px solid var(--navy); box-shadow: 0 2px 10px rgba(29, 53, 87, 0.2); }
        .btn-primary:hover { background-color: var(--cyan); border-color: var(--cyan); color: var(--navy-dark); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 195, 255, 0.3); }
        .btn-ghost { background: transparent; color: var(--navy); border: 1px solid var(--border-light); }
        .btn-ghost:hover { border-color: var(--navy); background: var(--white); }
        .btn-sm { padding: 8px 20px; font-size: 0.85rem; }
        .btn-full { width: 100%; }
        
        .nav { position: fixed; top: 0; width: 100%; z-index: 1000; padding: 16px 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.04); transition: top 0.3s ease, padding 0.3s ease, box-shadow 0.3s ease; }
        .nav.scrolled { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .nav-inner { display: flex; justify-content: flex-end; align-items: center; }
        .nav-menu { display: flex; gap: 32px; }
        .nav-link { font-size: 0.9rem; font-weight: 500; color: #64748B; position: relative; transition: color 0.3s; text-decoration: none; }
        .nav-link:hover { color: var(--navy); }

        /* Espaciados reducidos (Landing) */
        .hero { padding: 120px 0 40px; position: relative; overflow: hidden; }
        
        .bg-gradient-mesh { position: absolute; top: -20%; right: -10%; width: 800px; height: 800px; background: radial-gradient(circle, rgba(0, 195, 255, 0.05) 0%, rgba(255,255,255,0) 60%); z-index: -1; animation: breathe 10s infinite alternate; }
        .hero-grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 60px; align-items: center; }
        .hero h1 { font-size: 3.5rem; margin-bottom: 24px; line-height: 1.1; }
        .hero-desc { font-size: 1.15rem; color: #4B5563; margin-bottom: 32px; max-width: 90%; }
        .badge-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: #EFF6FF; color: var(--navy); border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; }
        .dot { width: 8px; height: 8px; background: var(--pidared); border-radius: 50%; box-shadow: 0 0 8px var(--cyan); }
        .hero-visual { height: 400px; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .anchor-core { width: 220px; height: 220px; background: radial-gradient(circle at 30% 30%, #ffffff, #f1f5f9); border-radius: 50%; box-shadow: 20px 20px 60px #d1d9e6, -20px -20px 60px #ffffff; position: relative; z-index: 10; display: flex; justify-content: center; align-items: center; animation: float 6s ease-in-out infinite; }
        .orbit-ring { position: absolute; border: 1px solid rgba(0, 195, 255, 0.2); border-radius: 50%; }
        .ring-1 { width: 320px; height: 320px; animation: spin 20s linear infinite; }
        .ring-2 { width: 400px; height: 400px; border-style: dashed; animation: spin 40s linear infinite reverse; }
        .floating-card { position: absolute; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border-light); box-shadow: 0 10px 30px rgba(0,0,0,0.08); font-size: 0.85rem; font-weight: 600; color: var(--navy); display: flex; align-items: center; gap: 8px; animation: float 5s ease-in-out infinite alternate; }
        .fc-1 { top: 20%; right: 10%; animation-delay: 1s; }
        .fc-2 { bottom: 20%; left: 0%; animation-delay: 2s; }
        
        /* Padding reducido entre secciones */
        section { padding: 50px 0; }
        
        .section-intro { text-align: center; max-width: 700px; margin: 0 auto 60px; }
        .section-intro h2 { font-size: 2.5rem; margin-bottom: 16px; }
        .bento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .bento-card { background: #F8FAFC; padding: 32px; border-radius: 16px; border: 1px solid transparent; transition: all 0.3s ease; }
        .bento-card:hover { background: var(--white); border-color: var(--border-light); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); transform: translateY(-4px); }
        .bento-wide { grid-column: span 2; display: flex; gap: 20px; align-items: center; }
        .icon-box { width: 48px; height: 48px; border-radius: 12px; background: rgba(29, 53, 87, 0.05); display: flex; justify-content: center; align-items: center; color: var(--navy); font-size: 1.25rem; margin-bottom: 20px; transition: 0.3s; }
        .bento-card:hover .icon-box { background: var(--cyan); color: var(--white); }
        .bento-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; color: var(--navy); }
        .pricing-compact { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .price-card { background: var(--white); border: 1px solid var(--border-light); border-radius: 16px; padding: 24px; transition: all 0.3s ease; display: flex; flex-direction: column; }
        .price-card:hover { border-color: var(--navy); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); }
        .price-card.featured { background: #F0F9FF; border: 2px solid var(--cyan); transform: scale(1.02); z-index: 2; }
        .plan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .plan-name { font-size: 1.1rem; font-weight: 700; color: var(--navy); }
        .price-value { font-size: 2.2rem; font-weight: 800; color: var(--navy); font-family: var(--font-display); }
        .price-features { margin-bottom: 24px; flex-grow: 1; }
        .price-features li { font-size: 0.85rem; color: var(--navy); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .check-icon { color: var(--cyan); font-size: 1rem; }
        .footer { padding: 80px 0 40px; background: var(--white); border-top: 1px solid var(--border-light); }
        .footer-cols { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 40px; margin-bottom: 60px; }
        .copyright { border-top: 1px solid var(--border-light); padding-top: 24px; font-size: 0.8rem; color: #94A3B8; display: flex; justify-content: space-between; }
        
        /* === ESTILOS DEL CARRUSEL DE TESTIMONIOS === */
        /* Padding inferior aumentado a 60px para que los dots no se corten */
        .carousel-container { position: relative; max-width: 800px; margin: 0 auto; overflow: hidden; padding-bottom: 60px; }
        .carousel-track { display: flex; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); width: 100%; }
        .testimonial-slide { min-width: 100%; box-sizing: border-box; padding: 10px 20px; }
        .testimonial-card { background: #F8FAFC; padding: 40px; border-radius: 16px; text-align: center; border: 1px solid transparent; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); transition: all 0.3s ease; }
        .testimonial-card:hover { background: var(--white); border-color: var(--border-light); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .quote-icon { font-family: 'Space Grotesk', sans-serif; font-size: 4rem; color: var(--navy); margin-bottom: 10px; line-height: 1; opacity: 0.1; display: block; height: 40px; }
        .testimonial-text { font-size: 1.15rem; font-style: italic; color: var(--navy); margin-bottom: 24px; line-height: 1.6; font-weight: 500; }
        .testimonial-author { display: block; font-weight: 700; color: var(--pidared); font-size: 1rem; letter-spacing: 0.5px; text-transform: uppercase; }
        
        /* Dots posicionados más arriba para no ser cortados por overflow */
        .carousel-dots { display: flex; justify-content: center; gap: 10px; margin-top: 20px; position: absolute; bottom: 15px; left: 0; right: 0; }
        .dot-btn { width: 10px; height: 10px; border-radius: 50%; background: #CBD5E1; border: none; cursor: pointer; transition: all 0.3s; padding: 0; }
        .dot-btn.active { background: var(--navy); transform: scale(1.3); }

        /* LEGAL MODAL STYLES */
        .legal-content h3 { color: var(--pida-primary); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.3rem; }
        .legal-content h4 { color: var(--pida-accent); margin-top: 15px; margin-bottom: 5px; font-size: 1rem; font-weight: 700; text-transform: uppercase;}
        .legal-content p, .legal-content li { font-size: 0.9rem; color: #4B5563; margin-bottom: 10px; line-height: 1.5; }
        .legal-content ul { padding-left: 20px; margin-bottom: 10px; }
        .legal-content strong { color: var(--navy); }
        .legal-content hr { border: 0; border-top: 1px solid #ddd; margin: 30px 0; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes breathe { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }
        @media (max-width: 900px) { .hero-grid, .pricing-compact, .bento-grid, .footer-cols { grid-template-columns: 1fr; gap: 40px; } .hero { padding-top: 100px; text-align: center; } .hero h1 { font-size: 2.2rem; margin-bottom: 20px; } .hero-content img { margin: 0 auto 20px auto; width: 80%; max-width: 300px; } .hero-desc { font-size: 1rem; } .hero-visual { height: 300px; margin-top: 40px; } .bento-wide { grid-column: span 1; } }

        /* =========================================
           2. ESTILOS DE LA APP
           ========================================= */
        #pida-app-layout { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--pida-bg-app); z-index: 99999; display: flex; color: var(--pida-text-main); transition: top 0.3s ease, height 0.3s ease; }
        #pida-app-root { all: initial; font-family: var(--pida-font); display: none; } 
        #pida-app-root * { box-sizing: border-box; font-family: var(--pida-font); }
        #pida-sidebar { width: 260px; background-color: var(--pida-primary); display: flex; flex-direction: column; padding-top: 25px; flex-shrink: 0; border-right: 1px solid rgba(255,255,255,0.05); }
        .pida-logo-container { margin-bottom: 30px; display: flex; justify-content: center; }
        .pida-sidebar-logo { width: 150px; height: auto; display: block; }
        .pida-main-nav { display: flex; flex-direction: column; gap: 10px; width: 100%; padding: 0 15px; flex-grow: 1; }
        .app-nav-link { background: transparent; border: none; color: rgba(255,255,255,0.7); width: 100%; padding: 12px 15px; border-radius: 8px; display: flex; align-items: center; justify-content: flex-start; gap: 15px; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; font-weight: 500; text-align: left; }
        .app-nav-link svg { width: 22px; height: 22px; flex-shrink: 0; }
        .app-nav-link:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .app-nav-link.active { background-color: var(--pida-accent); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: 600; }
        .pida-sidebar-user { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; margin-top: auto; }
        .pida-user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); object-fit: cover; cursor: pointer; }
        .pida-user-info { flex: 1; overflow: hidden; cursor: pointer; }
        .pida-user-name { display: block; color: white; font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pida-user-email { display: block; color: rgba(255,255,255,0.6); font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pida-logout-icon-btn { background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 5px; border-radius: 4px; transition: all 0.2s; }
        .pida-logout-icon-btn:hover { color: #ff6b6b; background: rgba(255,255,255,0.1); }
        #pida-main-content { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; overflow: hidden; }
        .pida-top-header { height: 70px; background-color: var(--pida-bg-white); border-bottom: 1px solid var(--pida-border); display: flex; align-items: center; padding: 0 30px; flex-shrink: 0; }
        .pida-context-controls { display: flex; align-items: center; gap: 15px; width: 100%; }
        .context-group { display: flex; align-items: center; gap: 10px; }
        .context-group.hidden { display: none; }
        .pida-header-btn { background: white; border: 1px solid var(--pida-border); padding: 8px 15px; border-radius: 6px; font-size: 0.9rem; color: var(--pida-text-main); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-weight: 500; }
        .pida-header-btn:hover { border-color: var(--pida-accent); color: var(--pida-accent); background: #f8fbff; }
        .pida-header-btn.primary { background: var(--pida-accent); color: white; border-color: var(--pida-accent); }
        .pida-header-btn.primary:hover { background: #004494; }
        .pida-header-mascot { height: 55px; width: auto; margin-left: auto; object-fit: contain; }
        .pida-view { display: flex; flex-direction: column; flex: 1; overflow: hidden; height: 100%; }
        .pida-view.hidden { display: none; }
        .pida-view-content { flex: 1; overflow-y: auto; padding: 30px 10%; scroll-behavior: smooth; }
        .pida-view-content::-webkit-scrollbar, .pida-dropdown-content::-webkit-scrollbar { width: 8px; }
        .pida-view-content::-webkit-scrollbar-thumb, .pida-dropdown-content::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }
        #pida-chat-box { display: flex; flex-direction: column; gap: 20px; padding-bottom: 20px; }
        
        /* ESTILOS DEL CHAT Y FORMATO DE RESPUESTAS */
        .pida-bubble { 
            max-width: 85%; padding: 20px 28px; border-radius: 12px; font-size: 1rem; line-height: 1.6; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); user-select: text!important; -webkit-user-select: text!important; 
        }
        .user-message-bubble { 
            align-self: flex-end; background-color: var(--pida-accent); color: white; border-bottom-right-radius: 2px; 
        }
        .pida-message-bubble { 
            align-self: flex-start; background-color: var(--pida-bg-white); color: var(--pida-text-main); 
            border: 1px solid var(--pida-border); border-bottom-left-radius: 2px; 
        }
        
        /* Formato de separadores en chat */
        .pida-bubble hr { border: 0; border-top: 1px solid #E5E7EB; margin: 25px 0 15px 0; height: 1px; display: block; }
        
        /* Markdown en burbujas */
        .pida-bubble p { margin-bottom: 1em; margin-top: 0; }
        .pida-bubble p:last-child { margin-bottom: 0; }
        .pida-bubble ul, .pida-bubble ol { margin-bottom: 1em; padding-left: 25px; margin-top: 0.5em; }
        .pida-bubble li { margin-bottom: 0.5em; padding-left: 5px; }
        .pida-bubble h1, .pida-bubble h2, .pida-bubble h3 { 
            font-weight: 700; margin-top: 1.2em; margin-bottom: 0.6em; color: var(--pida-primary); line-height: 1.3; 
        }
        .pida-bubble h1 { font-size: 1.3em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .pida-bubble h2 { font-size: 1.15em; }
        .pida-bubble strong { color: var(--pida-primary); font-weight: 700; }
        .pida-bubble a { color: var(--pida-accent); text-decoration: underline; font-weight: 600; }
        
        .user-message-bubble p, .user-message-bubble strong, .user-message-bubble h1, .user-message-bubble h2, .user-message-bubble li { color: white; border-color: rgba(255,255,255,0.3); }
        .user-message-bubble a { color: #dbeafe; }

        /* Analizador */
        #analyzer-analysis-result {
            background: white; padding: 40px; border-radius: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); font-family: 'Inter', sans-serif;
            color: #334155; line-height: 1.7; user-select: text!important; -webkit-user-select: text!important;
        }
        #analyzer-analysis-result h1, #analyzer-analysis-result h2, #analyzer-analysis-result h3 {
            color: var(--pida-primary); margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 700; line-height: 1.2;
        }
        #analyzer-analysis-result h1 { font-size: 1.8em; border-bottom: 2px solid var(--pida-accent); padding-bottom: 10px; }
        #analyzer-analysis-result h2 { font-size: 1.4em; }
        #analyzer-analysis-result h3 { font-size: 1.1em; color: var(--pida-accent); text-transform: uppercase; letter-spacing: 0.5px; }
        #analyzer-analysis-result p { margin-bottom: 1em; }
        #analyzer-analysis-result strong { color: var(--pida-primary); font-weight: 700; }
        #analyzer-analysis-result a { color: var(--pida-accent); text-decoration: underline; text-underline-offset: 2px; }
        #analyzer-analysis-result ul, #analyzer-analysis-result ol { margin-bottom: 1.5em; padding-left: 20px; }
        #analyzer-analysis-result li { margin-bottom: 0.5em; padding-left: 5px; }
        #analyzer-analysis-result li::marker { color: var(--pida-accent); font-weight: bold; }
        #analyzer-analysis-result blockquote {
            border-left: 4px solid var(--pida-accent); background: #f8fafc; margin: 1.5em 0; padding: 15px 20px; font-style: italic; color: #475569; border-radius: 0 8px 8px 0;
        }
        #analyzer-analysis-result table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.95rem; }
        #analyzer-analysis-result th { background-color: var(--pida-bg-app); color: var(--pida-primary); font-weight: 700; text-align: left; padding: 12px; border-bottom: 2px solid var(--pida-border); }
        #analyzer-analysis-result td { padding: 12px; border-bottom: 1px solid var(--pida-border); }
        #analyzer-analysis-result tr:hover { background-color: #f1f5f9; }
        
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--pida-accent);
            animation: spin 1s ease infinite;
            margin: 0 auto 10px;
        }
        
        .typing-indicator { display: flex; align-items: center; gap: 5px; padding: 5px 0; }
        .typing-dot { width: 8px; height: 8px; background-color: #EF4444; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .follow-up-card { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .follow-up-card h3 { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
        .follow-up-btn { display: block; width: 100%; text-align: left; background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; color: var(--pida-primary); cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .follow-up-btn:hover { background: white; border-color: var(--pida-accent); color: var(--pida-accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pida-view-form { background-color: var(--pida-bg-white); padding: 20px 10%; border-top: 1px solid var(--pida-border); z-index: 10; position: relative; }
        .pida-textarea { width: 100%; padding: 15px; border: 1px solid var(--pida-border); border-radius: 8px; font-size: 1rem; resize: none; background-color: #FAFAFA; outline: none; transition: all 0.3s; }
        .pida-textarea:focus { background: white; border-color: var(--pida-accent); box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
        .pida-form-actions { display: flex; justify-content: space-between; margin-top: 12px; }
        .pida-button-primary { background-color: var(--pida-accent); color: white; border: none; padding: 12px 28px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .pida-button-primary:hover { background-color: #004494; }
        .pida-button-secondary { background: none; border: none; color: var(--pida-text-muted); cursor: pointer; font-size: 0.9rem; }
        .pida-button-secondary:hover { color: var(--pida-text-main); text-decoration: underline; }
        .pida-download-controls { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 8px; }
        .pida-download-controls button { background: white; border: 1px solid var(--pida-border); color: var(--pida-text-muted); padding: 5px 12px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; font-weight: 600; }
        .pida-download-controls button:hover { border-color: var(--pida-accent); color: var(--pida-accent); }
        .pida-dropdown { position: relative; }
        .pida-dropdown-content { position: absolute; top: 110%; left: 0; width: 320px; background: white; border: 1px solid var(--pida-border); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; display: none; flex-direction: column; max-height: 400px; overflow-y: auto; padding: 5px; }
        .pida-dropdown-content.show { display: flex; }
        .pida-history-item { padding: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--pida-text-main); font-size: 0.9rem; margin-bottom: 2px; }
        .pida-history-item:hover { background: #F3F4F6; }
        .pida-history-item.active { background: #eff6ff; color: var(--pida-accent); font-weight: bold; }
        .pida-history-item-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 240px; }
        .delete-icon-btn { background: none; border: none; color: #EF4444; cursor: pointer; padding: 5px; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: all 0.2s; }
        .delete-icon-btn:hover { background-color: rgba(239,68,68,0.1); opacity: 1; }
        .delete-icon-btn svg { width: 14px; height: 14px; }
        .account-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; border: 1px solid var(--pida-border); padding: 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .account-header { margin-bottom: 30px; text-align: center; }
        .account-header h2 { color: var(--pida-primary); margin-bottom: 5px; }
        .account-section { margin-bottom: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .account-section:first-child { border-top: none; }
        .account-section h3 { font-size: 1rem; color: var(--pida-text-muted); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .pida-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .pida-input { width: 100%; padding: 10px; border: 1px solid var(--pida-border); border-radius: 6px; outline: none; }
        .pida-notification { padding: 10px; border-radius: 6px; color: white; text-align: center; margin-bottom: 15px; font-size: 0.9rem; }
        .pida-notification.success { background: #10B981; }
        .pida-notification.error { background: #EF4444; }
        .pida-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(29,53,87,0.95); z-index: 100000; display: flex; align-items: center; justify-content: center; }
        .pida-overlay.hidden { display: none; }
        .pida-overlay-content { background: white; padding: 40px; border-radius: 12px; text-align: center; }
        .pida-overlay-btn { display: inline-block; background: var(--pida-accent); color: white; padding: 12px 30px; border-radius: 30px; text-decoration: none; margin-top: 20px; }
        #active-files-area { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .active-file-chip { background: #eef2ff; color: var(--pida-accent); padding: 5px 12px; border-radius: 20px; border: 1px solid #c7d2fe; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .active-file-chip button { background: none; border: none; color: inherit; cursor: pointer; font-weight: bold; }
        
        /* LOGIN MODAL & TABS */
        #pida-login-screen { display: none; justify-content: center; align-items: center; height: 100vh; width: 100vw; background: rgba(29,53,87,0.95); position: fixed; top: 0; left: 0; z-index: 200000; backdrop-filter: blur(5px); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .login-logo { width: 120px; margin-bottom: 20px; }
        
        /* Login Tabs */
        .login-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .login-tab-btn { flex: 1; padding: 10px; background: none; border: none; border-bottom: 2px solid transparent; font-size: 0.95rem; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; }
        .login-tab-btn.active { color: var(--pida-accent); border-bottom-color: var(--pida-accent); }
        .login-tab-btn:hover { color: var(--navy); }

        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background-color: var(--pida-accent); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .login-btn:hover { background-color: #004494; }
        .google-btn { background-color: white; color: #757575; border: 1px solid #ddd; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .google-btn:hover { background-color: #f9f9f9; border-color: #ccc; }
        .login-divider { margin: 20px 0; border-top: 1px solid #eee; position: relative; }
        .login-divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #999; font-size: 0.8rem; }
        .login-error { color: #EF4444; font-size: 0.9rem; margin-top: 10px; display: none; padding: 10px; background: rgba(239,68,68,0.1); border-radius: 6px; text-align: left;}
        .close-login-btn { position: absolute; top: 15px; right: 15px; border: none; background: none; font-size: 24px; cursor: pointer; color: #999; }

        @media (max-width: 768px) {
            #pida-sidebar { width: 100%; height: 65px; flex-direction: row; justify-content: space-around; align-items: center; padding: 0; position: fixed; bottom: 0; left: 0; top: auto; z-index: 10000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
            .pida-logo-container, .pida-sidebar-user { display: none; }
            .pida-main-nav { flex-direction: row; padding: 0; gap: 0; height: 100%; }
            .app-nav-link { flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; padding: 5px; border-radius: 0; gap: 4px; }
            .app-nav-link span { display: block; font-size: 0.7rem; line-height: 1; }
            .app-nav-link svg { width: 24px; height: 24px; margin: 0; }
            #pida-main-content { padding-bottom: 65px; height: 100%; }
            .pida-top-header { padding: 0 15px; height: 60px; }
            .pida-header-mascot { height: 40px; }
            .pida-view-form { padding: 15px; position: relative; z-index: 20; background: var(--pida-bg-white); }
            .pida-form-actions { flex-wrap: wrap; gap: 10px; margin-top: 10px; }
            .pida-button-primary { width: 100%; padding: 12px; order: 1; }
            .pida-button-secondary { width: 100%; text-align: center; margin-top: 0; order: 2; padding: 10px; }
            .pida-download-controls { justify-content: center; margin-bottom: 12px; }
            .pida-bubble { max-width: 95%; padding: 12px 16px; }
            .account-container { padding: 20px; border: none; box-shadow: none; }
            .pida-view-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- LOADER GLOBAL (MODIFICADO: FONDO BLANCO, SOLO IMAGEN) -->
    <div id="pida-global-loader">
        <img src="img/PIDA-MASCOTA-Trans-menu.png" alt="Cargando..." class="loader-mascot-img">
    </div>

    <!-- BANNER ALERTA SISTEMA -->
    <div id="system-alert-banner" class="system-banner hidden">
        <strong>Mensaje de PIDA:</strong>&nbsp;
        <span id="system-alert-text">...</span>
        <button onclick="closeBanner()">×</button>
    </div>

    <!-- LANDING PAGE -->
    <div id="landing-page-root">
        <header class="nav" id="navbar">
            <div class="wrapper nav-inner">
                <nav class="nav-menu">
                    <a href="#diferencia" class="nav-link">Diferencia PIDA</a>
                    <a href="#bondades" class="nav-link">Bondades</a>
                    <a href="#planes" class="nav-link">Planes</a>
                </nav>
            </div>
        </header>

        <main>
            <section class="hero">
                
                <div class="wrapper hero-grid">
                    <div class="hero-content">
						<div><img src=img/PIDA_logo-576.png></div>
                        
                        <h1>Inteligencia Aumentada para la Defensa de los <br><span class="text-gradient">Derechos Humanos</span></h1>
                        <p class="hero-desc">Los asistentes de Inteligencia Artificial genéricos son un océano de información, pero sin un ancla, pueden llevarte a la deriva con datos imprecisos.</p>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: flex-start;">
                            <button id="cta-hero" class="btn btn-primary trigger-login">Entrar a PIDA</button>
                        </div>
                    </div>
					<div><img style="border-radius:8px"; src=img/PersonaTecno-576.png></div>
                </div>
            </section> 	

            <section id="diferencia">
                <div class="wrapper">
                    <div class="section-intro"><h2>¿Cuál es la gran diferencia de PIDA?</h2><p>PIDA no improvisa buscando en el caos de internet. Su punto de partida es la biblioteca del <strong>IIRESODH</strong>, una institución referente con más de 30 años de experiencia en Litigio Estratégico Internacional.</p><p>Primero, PIDA consulta este acervo validado por expertos en Derechos Humanos para obtener el fundamento correcto. Luego, usa la IA para construir tu respuesta. Así obtienes la velocidad de la tecnología, pero con la <strong>autoridad y el rigor técnico</strong> que solo el IIRESODH puede garantizar.</p></div>
                    <div class="bento-grid">
                        <div class="bento-card"><div><img src=img/icono_01.png></div><div><h3 class="bento-title">Económico</h3><p>PIDA cuesta menos que la competencia</p></div></div>
                        <div class="bento-card"><div><img src=img/icono_03.png></div><h3 class="bento-title">Seguro</h3><p>Tus datos viajan encriptados y no se comparten</p></div>
						<div class="bento-card"><div><img src=img/Icon_App-Mobile.png></div><h3 class="bento-title">Móvil</h3><p>Funciona en cualquier dispositivo móvil</p></div>
                    </div>
                </div>
            </section>

            <section id="bondades" style="background: #FAFAFA;">
                <div class="wrapper">
                    <h2 style="margin-bottom: 40px; text-align: center;">Bondades únicas de PIDA</h2>
                    <div class="bento-grid">
                        <div class="bento-card"><h3 class="bento-title">Respuestas Ancladas, no Adivinanzas</h3><p>Cada respuesta está fundamentada y prioriza el conocimiento del IIRESODH. Esto le da un nivel de fiabilidad y precisión que las IAs genéricas no pueden ofrecer, minimizando el riesgo de información incorrecta.</p></div>
                        <div class="bento-card"><h3 class="bento-title">Lo Mejor de Dos Mundos</h3><p>Combina la sabiduría especializada del IIRESODH con la capacidad de razonamiento y redacción de un modelo de IA de vanguardia. Obtienes respuestas con calidad de experto, no solo texto genérico.</p></div>
                        <div class="bento-card"><h3 class="bento-title">Eficiencia Acelerada</h3><p>El “Analizador de Documentos” sigue siendo tu experto incansable, capaz de procesar tus archivos y extraer información clave en minutos, liberándote para la estrategia y la acción.</p></div>
                    </div>
                </div>
            </section>

							<!-- STRIPE CONFIGURATION PLACEHOLDER: data-plan should match STRIPE_PRICES keys below -->
            <section id="planes">
                <div class="wrapper">
                    <div class="section-intro"><h2>Planes Flexibles</h2></div>
                    <div class="pricing-compact">
                        <div class="price-card">
                            <div class="plan-header"><span class="plan-name">Mensual Libre</span></div>
                            <div><span class="price-value">$29.99</span><span class="price-period">/mes</span></div>
                            <p class="price-desc">¡Suscríbete con libertad y paga mes por mes!</p>
                            <ul class="price-features"><li><span class="check-icon">✓</span> Pago mensual</li><li><span class="check-icon">✓</span> Sin compromiso</li></ul>                          
                            <button class="btn btn-primary btn-sm btn-full plan-cta" data-plan="basic">Quiero el Plan Libre</button>
                        </div>
                        <div class="price-card featured">
                            <div class="plan-header"><span class="plan-name">Mensual</span><span class="plan-badge"><strong><i>Popular</i></strong></span></div>
                            <div><span class="price-value">$27.49</span><span class="price-period">/mes</span></div>
                            <p class="price-desc">¡Ahorra con la suscripción anual y pago mensual!</p>
                            <ul class="price-features"><li><span class="check-icon">✓</span> <strong> Pago mensual</strong></li><li><span class="check-icon">✓</span> Compromiso anual</li></ul>
                            <button class="btn btn-primary btn-sm btn-full plan-cta" data-plan="pro">¡Quiero Ahorrar!</button>
                        </div>
                        <div class="price-card">
                            <div class="plan-header"><span class="plan-name">Anual</span></div>
                            <div><span class="price-value">$299.99</span><span class="price-period">/año</span></div>
                            <p class="price-desc">¡Ahorra más con la suscripción anual!</p>
                            <ul class="price-features"><li><span class="check-icon">✓</span> Pago Anual</li><li><span class="check-icon">✓</span> ¡Costo más bajo!</li></ul>
                            <button class="btn btn-primary btn-sm btn-full plan-cta" data-plan="corp">Contratar Plan Anual</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN TESTIMONIOS (REUBICADA Y CORREGIDA) -->
            <section id="testimonios">
                <div class="wrapper">
                    <div class="section-intro" style="margin-bottom: 30px;">
                        <h2>Lo que dicen nuestros usuarios</h2>
                    </div>
                    <div class="carousel-container">
                        <div class="carousel-track" id="carouselTrack">
                            <!-- Testimonio 1 -->
                            <div class="testimonial-slide">
                                <div class="testimonial-card">
                                    <span class="quote-icon">“</span>
                                    <p class="testimonial-text">PIDA me dio respuestas mucho más completas y técnicas de lo que yo andaba buscando, me da mucha confianza.</p>
                                    <span class="testimonial-author">Carlos Urquilla</span>
                                </div>
                            </div>
                            <!-- Testimonio 2 -->
                            <div class="testimonial-slide">
                                <div class="testimonial-card">
                                    <span class="quote-icon">“</span>
                                    <p class="testimonial-text">Este sistema PIDA me ha gustado mucho por la calidad de información que proporciona. He realizado varias consultas y han satisfecho mis expectativas.</p>
                                    <span class="testimonial-author">Alexandra Esquivel</span>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-dots" id="carouselDots">
                            <button class="dot-btn active"></button>
                            <button class="dot-btn"></button>
                        </div>
                    </div>
                </div>
            </section>
            
            <div class="wrapper">                   
                <div class="copyright"><span>&copy; 2025 IIRESODH PAYMENTS, LLC.</span>
				<a href="#" id="open-legal-btn" style="color: var(--navy); text-decoration: none;">Términos de uso y política de privacidad</a>
				<a href="mailto:contacto@pida-ai.com" style="color: var(--navy); text-decoration: none;">contacto@pida-ai.com</a>
				</div>
				<br>&nbsp;
            </div>
        </main>
    </div>

    <!-- LEGAL MODAL (HIDDEN) -->
    <div id="pida-legal-modal" class="pida-overlay hidden" style="z-index: 200001; align-items: flex-start; padding-top: 50px;">
        <div class="login-card" style="max-width: 800px; text-align: left; max-height: 85vh; overflow-y: auto; position: relative;">
            <button class="close-login-btn" onclick="document.getElementById('pida-legal-modal').classList.add('hidden')">×</button>
            <div class="legal-content">
                <h3>TÉRMINOS Y CONDICIONES DE USO DE PIDA</h3>
                <p><em>Última actualización: 16 de octubre de 2025</em></p>
                <p>Estos Términos y Condiciones ("Los Términos") rigen su acceso y uso de los servicios proporcionados por <strong>IIRESODH PAYMENTS, LLC.</strong>, una sociedad de responsabilidad limitada de Delaware, EE. UU. ("La Empresa", "Nosotros"). La Empresa opera la plataforma "PIDA - Plataforma de Investigación y Defensa Avanzada" ("El Servicio", "PIDA"), cuya marca y logo son propiedad de Asociación Instituto Internacional de Responsabilidad Social y Derechos Humanos (IIRESODH) y utilizados bajo licencia por La Empresa. Al acceder o utilizar El Servicio, usted ("El Usuario") acepta estar legalmente vinculado por estos Términos.</p>

                <h4>Descripción del Servicio: PIDA es un Asistente, no un Sustituto</h4>
                <p>PIDA - Plataforma de Investigación y Defensa Avanzada es una herramienta de asistencia jurídica impulsada por Inteligencia Artificial ("IA"), diseñada específicamente para apoyar a profesionales, académicos y defensores del derecho en la investigación, redacción y análisis de información relacionada con los derechos humanos.</p>
                <ul>
                    <li><strong>Herramienta de Aumento de Capacidad:</strong> El Usuario reconoce que El Servicio es una herramienta para aumentar su capacidad profesional, no para reemplazar su juicio, experiencia o conocimiento legal.</li>
                    <li><strong>Responsabilidad Profesional Final:</strong> La responsabilidad final sobre cualquier documento, estrategia, consejo o decisión basada en la información generada por PIDA recae exclusivamente en el Usuario. El Servicio no constituye una asesoría legal ni crea una relación abogado-cliente.</li>
                </ul>

                <h4>Obligación de Verificación</h4>
                <ul>
                    <li><strong>Posibilidad de Errores:</strong> La IA, por su naturaleza, puede cometer errores y generar información inexacta, incompleta o desactualizada.</li>
                    <li><strong>Deber de Diligencia del Usuario:</strong> El Usuario tiene la obligación ineludible de verificar siempre la exactitud, validez y aplicabilidad de toda la información proporcionada por PIDA, incluyendo citas de jurisprudencia, artículos de tratados, datos fácticos y cualquier otro dato crucial antes de utilizarlo en un caso real.</li>
                </ul>

                <h4>Suscripciones, Pagos y Facturación</h4>
                <ul>
                    <li><strong>Modalidad de Servicio:</strong> El acceso al Servicio requiere una suscripción activa, que puede ser mensual o anual ("Período de Suscripción"). Las tarifas se especificarán en el momento de la compra.</li>
                    <li><strong>Procesador de Pagos:</strong> Todos los pagos son procesados a través de Stripe, Inc. ("Stripe"). Al suscribirse, usted proporciona su información de pago directamente a Stripe y acepta los términos y condiciones de Stripe. La Empresa no almacena la información completa de su tarjeta de crédito.</li>
                    <li><strong>Renovación y Cancelación:</strong> Su suscripción se renovará automáticamente al final de cada Período de Suscripción. Usted puede cancelar la renovación en cualquier momento a través del portal de gestión de cuenta. La cancelación será efectiva al término del período ya pagado.</li>
                    <li><strong>Impuestos y Facturación:</strong> Los precios mostrados no incluyen impuestos, como el Impuesto al Valor Agregado (IVA) u otros impuestos aplicables en su jurisdicción. Dichos impuestos serán añadidos al precio final y desglosados en el momento del pago, conforme a la legislación vigente. La Empresa emitirá un comprobante de pago o factura que cumpla con los requisitos fiscales aplicables. El Usuario es responsable de proporcionar la información fiscal correcta para la emisión de dichos documentos.</li>
                </ul>

                <h4>Confidencialidad y Manejo de la Información</h4>
                <ul>
                    <li><strong>Responsabilidad sobre la Información:</strong> El Usuario es el único responsable de la información y los documentos que carga en El Servicio.</li>
                    <li><strong>Limitación sobre Información Sensible:</strong> El Usuario se compromete a evitar cargar documentos o ingresar información personal extremadamente sensible que no deba ser procesada por sistemas de terceros. Para más detalles, consulte nuestra Política de Privacidad.</li>
                </ul>

                <h4>Propiedad Intelectual</h4>
                <ul>
                    <li><strong>De la Marca y el Logo:</strong> La marca "PIDA - Plataforma de Investigación y Defensa Avanzada", su logo y cualquier otro identificador de marca asociado son propiedad exclusiva de IIRESODH y son utilizados por La Empresa bajo una licencia comercial.</li>
                    <li><strong>Del Software y la Plataforma:</strong> Todos los derechos sobre el software, código, arquitectura y componentes funcionales que constituyen El Servicio son propiedad de IIRESODH PAYMENTS, LLC.</li>
                    <li><strong>Del Contenido del Usuario y Generado:</strong> El Usuario retiene la propiedad sobre la información que ingresa y es propietario del contenido específico generado a partir de sus instrucciones. Sin embargo, otorga a La Empresa una licencia mundial y no exclusiva para usar, de forma anónima y agregada, los datos para mejorar El Servicio.</li>
                </ul>

                <h4>Limitación de Responsabilidad e Indemnización</h4>
                <p>EN LA MÁXIMA MEDIDA PERMITIDA POR LA LEY, LA EMPRESA NO SERÁ RESPONSABLE POR NINGÚN DAÑO INDIRECTO, INCIDENTAL, ESPECIAL O CONSECUENTE QUE RESULTE DE SU USO O INCAPACIDAD DE USO DEL SERVICIO, O DE CUALQUIER ERROR U OMISIÓN EN EL CONTENIDO GENERADO.</p>
                <p>El Usuario acepta defender e indemnizar a IIRESODH PAYMENTS, LLC., sus directivos y empleados, de cualquier reclamo o gasto que surja de su uso del Servicio o de la violación de estos Términos.</p>

                <h4>Ley Aplicable y Resolución de Disputas</h4>
                <ul>
                    <li><strong>Ley Aplicable:</strong> Estos Términos se regirán por las leyes del Estado de Delaware, Estados Unidos de América.</li>
                    <li><strong>Arbitraje Vinculante:</strong> Cualquier disputa o reclamo relacionado con estos Términos se resolverá mediante arbitraje vinculante administrado por la Asociación Americana de Arbitraje (AAA), en lugar de en un tribunal.</li>
                    <li><strong>Renuncia a Demandas Colectivas:</strong> USTED E IIRESODH PAYMENTS, LLC. ACUERDAN QUE CUALQUIER PROCEDIMIENTO DE RESOLUCIÓN DE DISPUTAS SE LLEVARÁ A CABO ÚNICAMENTE DE FORMA INDIVIDUAL Y NO EN UNA ACCIÓN COLECTIVA O REPRESENTATIVA.</li>
                </ul>
                <p>Contacto: Si tiene alguna pregunta sobre estos Términos, puede contactarnos en: contacto@pida-ai.com</p>

                <hr>

                <h3>POLÍTICA DE PRIVACIDAD DE PIDA</h3>
                <p><em>Última actualización: 16 de octubre de 2025</em></p>
                <p>IIRESODH PAYMENTS, LLC. ("Nosotros", "La Empresa"), una sociedad de responsabilidad limitada de Delaware, EE. UU., opera el servicio "PIDA - Plaraforma de Investigación y Devensa Avanzada" ("El Servicio"), cuya marca y logo son propiedad de Asociación Instituto Internacional de Responsabilidad Social y Derechos Humanos (IIRESODH) y utilizados bajo licencia por La Empresa. Esta política de privacidad explica cómo tratamos sus datos.</p>

                <h4>Responsable del Tratamiento de Datos</h4>
                <ul>
                    <li><strong>Nombre de la entidad:</strong> IIRESODH PAYMENTS, LLC.</li>
                    <li><strong>Correo electrónico de contacto:</strong> contacto@pida-ai.com</li>
                    <li><strong>Dirección:</strong> 131 Continental Dr Suite 305 Newark DE 19713, EE.UU.</li>
                </ul>

                <h4>Datos que Recopilamos</h4>
                <ul>
                    <li><strong>Datos de Identidad y Contacto:</strong> Nombre, correo electrónico, país.</li>
                    <li><strong>Datos Financieros:</strong> Para procesar sus pagos de suscripción, utilizamos Stripe. Recopilamos información de facturación, pero su información de tarjeta de crédito completa es enviada directamente a Stripe y nunca es almacenada en nuestros servidores.</li>
                    <li><strong>Datos de Uso y Técnicos:</strong> Información sobre cómo utiliza El Servicio, dirección IP, tipo de navegador, etc.</li>
                    <li><strong>Contenido del Usuario:</strong> Los documentos, textos y preguntas que usted ingresa en PIDA para su procesamiento.</li>
                </ul>

                <h4>Finalidades del Tratamiento de Datos</h4>
                <p><strong>Finalidades Primarias:</strong> Utilizamos sus datos para las siguientes finalidades, que son necesarias para prestar El Servicio:</p>
                <ul>
                    <li>Administrar su cuenta y suscripción.</li>
                    <li>Procesar sus solicitudes y el Contenido del Usuario para generar las respuestas.</li>
                    <li>Procesar sus pagos a través de nuestro proveedor.</li>
                    <li>Comunicarnos con usted sobre asuntos esenciales de su cuenta y del servicio.</li>
                </ul>
                <p><strong>Finalidades Secundarias:</strong> Sujeto a su consentimiento donde sea requerido, podremos usar sus datos de contacto para enviarle información sobre nuevos productos o mejoras. Usted podrá oponerse a este uso en cualquier momento.</p>

                <h4>Comunicación y Transferencia de Datos a Terceros</h4>
                <p>No vendemos sus datos personales. Compartimos información con terceros de confianza (subprocesadores) que nos ayudan a operar:</p>
                <ul>
                    <li><strong>Proveedores de Infraestructura en la Nube:</strong> Para alojar nuestra plataforma y procesar sus datos de forma segura, utilizamos los servicios de Google (Google Cloud y Firebase). Su información, incluido el Contenido del Usuario, se almacena en esta infraestructura.</li>
                    <li><strong>Procesador de Pagos:</strong> Compartimos la información de facturación y transacciones con Stripe para procesar los pagos de su suscripción de forma segura.</li>
                    <li><strong>Proveedores de Modelos de IA:</strong> Podemos utilizar modelos de IA de terceros para potenciar El Servicio, compartiendo solo la información necesaria para cada solicitud bajo estrictos acuerdos de confidencialidad.</li>
                </ul>
                <p><strong>Transferencia Internacional de Datos:</strong> La Empresa tiene su sede en los Estados Unidos. Al utilizar El Servicio, usted acepta que su información personal sea transferida, almacenada y procesada en los Estados Unidos. Adicionalmente, al utilizar una infraestructura de nube global, sus datos pueden ser procesados en centros de datos ubicados en distintas regiones geográficas. Su consentimiento a esta Política representa su acuerdo con estas transferencias.</p>

                <h4>Seguridad y Retención</h4>
                <ul>
                    <li><strong>Seguridad de los Datos:</strong> Construimos nuestra plataforma sobre una infraestructura de nube segura y líder en la industria, aprovechando sus avanzadas capacidades de seguridad y encriptación. Además, todos los pagos se gestionan a través de Stripe, un procesador certificado con los más altos estándares de seguridad (PCI DSS).</li>
                    <li><strong>Retención de Datos:</strong> Conservaremos sus datos solo durante el tiempo necesario para prestarle el servicio y cumplir con nuestras obligaciones legales.</li>
                </ul>

                <h4>Sus Derechos sobre sus Datos Personales (Derechos ARCO)</h4>
                <p><strong>Derechos del Titular:</strong> Conforme a la legislación aplicable en su país, usted tiene derecho a:</p>
                <ul>
                    <li><strong>Acceso:</strong> Conocer qué datos personales tenemos de usted y cómo los tratamos.</li>
                    <li><strong>Rectificación:</strong> Solicitar la corrección de su información si es inexacta o incompleta.</li>
                    <li><strong>Cancelación:</strong> Solicitar que eliminemos sus datos de nuestros registros.</li>
                    <li><strong>Oposición:</strong> Oponerse al uso de sus datos personales para fines específicos.</li>
                </ul>
                <p><strong>Procedimiento para Ejercer sus Derechos:</strong> Para ejercer cualquiera de estos derechos, por favor envíe una solicitud por correo electrónico a privacidad@pida-ai.com, especificando claramente su nombre, el derecho que desea ejercer y adjuntando una copia de un documento de identidad para verificar que es el titular de los datos.</p>
                <p><strong>Autoridades Locales:</strong> Usted también tiene derecho a presentar una queja ante la autoridad de protección de datos de su país si considera que sus derechos han sido vulnerados. Ejemplos de estas autoridades son el Instituto Nacional de Transparencia, Acceso a la Información y Protección de Datos Personales (INAI) en México o la Superintendencia de Industria y Comercio (SIC) en Colombia.</p>

                <h4>Privacidad de los Menores de Edad</h4>
                <p>Nuestro Servicio no está dirigido a personas menores de 18 años.</p>

                <h4>Cambios a esta Política de Privacidad</h4>
                <p>Nos reservamos el derecho de actualizar esta política. Le notificaremos cualquier cambio publicándolo en esta página.</p>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL PROFESSIONAL -->
    <div id="pida-login-screen">
        <div class="login-card">
            <button class="close-login-btn" onclick="document.getElementById('pida-login-screen').style.display='none'">×</button>
            <img src="https://pida-ai.com/wp-content/uploads/2025/09/logo-2.png" alt="PIDA Logo" class="login-logo" onerror="this.style.display='none'">
            
            <div class="login-tabs">
                <button class="login-tab-btn active" id="tab-login" onclick="switchAuthMode('login')">Ingresar</button>
                <button class="login-tab-btn" id="tab-register" onclick="switchAuthMode('register')">Crear Cuenta</button>
            </div>

            <h2 id="auth-title" style="color: var(--pida-primary); margin-top: 0; font-size: 1.2rem;">Bienvenido de nuevo</h2>
            <p id="auth-desc" style="color: #666; margin-bottom: 20px;">Accede para continuar tu investigación.</p>
            
            <button id="google-login-btn" class="login-btn google-btn"><svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg> <span id="google-text">Entrar con Google</span></button>
            
            <div class="login-divider"><span>O usa tu correo</span></div>
            
            <form id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="Correo electrónico" required>
                <input type="password" id="login-password" class="login-input" placeholder="Contraseña" required>
                <button type="submit" class="login-btn" id="auth-submit-btn">Entrar</button>
            </form>
            <div id="login-message" class="login-error"></div>
        </div>
    </div>

    <!-- APP DASHBOARD -->
    <div id="pida-app-root">
        <div id="pida-subscription-overlay" class="pida-overlay hidden">
            <div class="pida-overlay-content">
                <h2 style="color: var(--pida-primary);">Acceso Restringido</h2>
                <p style="color: var(--pida-text-muted);">No tienes una suscripción activa.</p>
                <a href="#planes" class="pida-overlay-btn" onclick="document.getElementById('pida-app-root').style.display='none'; document.getElementById('landing-page-root').style.display='block'; window.location.hash='planes';">Ver Planes</a>
            </div>
        </div>
        <div id="pida-app-layout">
            <aside id="pida-sidebar">
                <div class="pida-logo-container">
                    <a href="#" id="app-home-link"><img src="img/PIDA-logo-blanco-scaled.png" alt="PIDA" class="pida-sidebar-logo"></a>
                </div>
                <nav class="pida-main-nav">
                    <button id="nav-investigador" type="button" class="app-nav-link active"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.031 16.6168L22.3137 20.8995L20.8995 22.3137L16.6168 18.031C15.0769 19.263 13.124 20 11 20C6.032 20 2 15.968 2 11C2 6.032 6.032 2 11 2C15.968 2 20 6.032 20 11C20 13.124 19.263 15.0769 18.031 16.6168ZM11 18C14.866 18 18 11C18 7.13401 14.866 4 11 4C7.13401 4 4 7.13401 4 11C4 14.866 7.13401 18 11 18Z"></path></svg><span>Experto en DDHH</span></button>
                    <button id="nav-analizador" type="button" class="app-nav-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 4H5V20H19V8H15V4ZM3 2.9918C3 2.44405 3.44749 2 3.99826 2H16L21 7V20.9925C21 21.5489 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.556 3 21.0082V2.9918ZM13 12H7V14H13V12ZM13 16H7V18H13V16Z"></path></svg><span>Analizador Docs</span></button>
                </nav>
                <div class="pida-sidebar-user">
                    <img id="pida-profile-avatar" src="" class="pida-user-avatar" alt="Avatar" />
                    <div class="pida-user-info" id="sidebar-user-info-click">
                        <span id="pida-profile-name" class="pida-user-name">Usuario</span>
                        <span id="pida-profile-email" class="pida-user-email">...</span>
                    </div>
                    <button id="pida-profile-logout" class="pida-logout-icon-btn" title="Cerrar Sesión"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                </div>
            </aside>
            <main id="pida-main-content">
                <header class="pida-top-header">
                    <div class="pida-context-controls">
                        <div id="chat-controls" class="context-group">
                            <button id="pida-new-chat-btn" class="pida-header-btn primary">+ Nuevo Chat</button>
                            <div class="pida-dropdown">
                                <button id="history-dropdown-btn" class="pida-header-btn">📜 Historial <span style="font-size: 0.7rem;">▼</span></button>
                                <div id="history-dropdown-content" class="pida-dropdown-content"><div id="pida-history-list"></div></div>
                            </div>
                        </div>
                        <div id="analyzer-controls" class="context-group hidden">
                            <button id="analyzer-upload-btn" class="pida-header-btn primary">☁️ Subir Archivos</button>
                            <input id="analyzer-file-upload" type="file" style="display: none;" multiple accept=".pdf,.doc,.docx" />
                            <div class="pida-dropdown">
                                <button id="analyzer-history-dropdown-btn" class="pida-header-btn">📊 Análisis Previos <span style="font-size: 0.7rem;">▼</span></button>
                                <div id="analyzer-history-dropdown-content" class="pida-dropdown-content"><div id="analyzer-history-list"></div></div>
                            </div>
                        </div>
                        <div id="account-controls" class="context-group hidden">
                            <h2 style="margin:0; font-size: 1.2rem; color: var(--pida-primary);">Gestión de Cuenta</h2>
                        </div>
                        <img src="img/PIDA-MASCOTA-menu.png" alt="PIDA Mascota" class="pida-header-mascot">
                    </div>
                </header>
                
                <div id="view-investigador" class="pida-view">
                    <div class="pida-view-content"><div id="pida-chat-box"></div></div>
                    <form id="pida-form" class="pida-view-form">
                        <div id="pida-download-controls" class="pida-download-controls" style="display:flex;justify-content:flex-end;gap:5px;margin-bottom:5px;">
                            <button type="button" id="chat-download-txt-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">TXT</button>
                            <button type="button" id="chat-download-docx-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">DOCX</button>
                            <button type="button" id="chat-download-pdf-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">PDF</button>
                        </div>
                        <textarea id="pida-input" class="pida-textarea" rows="2" placeholder="Consulta al Experto en DDHH..."></textarea>
                        <div class="pida-form-actions">
                            <button id="chat-clear-btn" type="button" class="pida-button-secondary">Limpiar</button>
                            <button id="pida-send-btn" type="submit" class="pida-button-primary">Enviar</button>
                        </div>
                    </form>
                </div>

                <div id="view-analizador" class="pida-view hidden">
                    <div class="pida-view-content">
                        <div id="analyzer-results-section" style="display: none;">
                            <div id="analyzer-loader-container" style="text-align: center; margin-top: 40px;">
                                <div class="loader"></div><p style="color: var(--pida-text-muted);">Analizando documentos...</p>
                            </div>
                            <div id="analyzer-response-container">
                                <h2 style="text-align: center; color: var(--pida-primary); margin-bottom:30px; margin-top: 20px;">Resultado del Análisis</h2>
                                <div id="analyzer-analysis-result" style="background:white;padding:30px;border-radius:8px;border:1px solid var(--pida-border);"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pida-view-form">
                        <div id="active-files-area" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;"></div>
                        <div id="analyzer-download-controls" class="pida-download-controls" style="display: none; justify-content:flex-end; gap:5px; margin-bottom:5px;">
                            <button type="button" id="analyzer-download-txt-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">TXT</button>
                            <button type="button" id="analyzer-download-docx-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">DOCX</button>
                            <button type="button" id="analyzer-download-pdf-btn" class="pida-header-btn" style="padding:2px 8px;font-size:0.7rem;">PDF</button>
                        </div>
                        <textarea id="user-instructions" rows="2" class="pida-textarea" placeholder="Instrucciones para el análisis..."></textarea>
                        <div class="pida-form-actions">
                            <button id="analyzer-clear-btn" type="button" class="pida-button-secondary">Limpiar</button>
                            <button id="analyze-btn" type="button" class="pida-button-primary">Analizar</button>
                        </div>
                    </div>
                </div>

                <div id="view-account" class="pida-view hidden">
                    <div class="pida-view-content">
                        <div class="account-container" style="max-width:600px;margin:0 auto;background:white;border-radius:12px;border:1px solid var(--pida-border);padding:40px;">
                            <div id="account-notification-area"></div>
                            <div class="account-header" style="text-align:center;margin-bottom:30px;"><h2>Mi Cuenta</h2><p style="color:#666;">Gestiona tu perfil y suscripción.</p></div>
                            <div class="account-section" style="margin-bottom:30px;border-top:1px solid #eee;padding-top:20px;">
                                <h3 style="font-size:1rem;color:var(--pida-text-muted);margin-bottom:15px;text-transform:uppercase;">Perfil Personal</h3>
                                <div style="display:flex;gap:10px;margin-bottom:15px;">
                                    <input type="text" id="acc-firstname" class="pida-textarea" style="padding:10px;" placeholder="Nombre">
                                    <input type="text" id="acc-lastname" class="pida-textarea" style="padding:10px;" placeholder="Apellido">
                                </div>
                                <button id="acc-update-btn" class="pida-button-primary" style="width:100%;">Actualizar Nombre</button>
                            </div>
                            <div class="account-section" style="margin-bottom:30px;border-top:1px solid #eee;padding-top:20px;">
                                <h3 style="font-size:1rem;color:var(--pida-text-muted);margin-bottom:15px;text-transform:uppercase;">Suscripción</h3>
                                <button id="acc-billing-btn" class="pida-button-primary" style="width:100%; background-color: #2A4B7C;">Portal de Facturación</button>
                            </div>
                            <div class="account-section" style="border-top:1px solid #eee;padding-top:20px;">
                                <h3 style="font-size:1rem;color:var(--pida-text-muted);margin-bottom:15px;text-transform:uppercase;">Seguridad</h3>
                                <button id="acc-reset-btn" class="pida-button-secondary" style="border: 1px solid #ccc; width:100%; padding: 10px; border-radius: 6px;">Restablecer contraseña</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- MAIN JS LOGIC -->
    <script>
        // ------------- CONFIGURATION ZONE -------------
        const STRIPE_ROLE_PRICES = {
            basic: 'price_1SaPl3GaDEQrzamxTlz82k7h', 
            pro:   'price_1SaPr0GaDEQrzamxsnersmcq',
            corp:  'price_1SaPn7GaDEQrzamxdk96YPUh'
        };
        
        const PIDA_CONFIG = {
            API_CHAT: "https://chat-v20-465781488910.us-central1.run.app",
            API_ANA: "https://analize-v20-465781488910.us-central1.run.app",
            FIREBASE: {
                apiKey: "AIzaSyC5nqsx4Fe4gMKkKdvnbMf8VFnI6TYL64k",
                authDomain: "pida-ai.com",
                projectId: "pida-ai-v20",
                storageBucket: "pida-ai-v20.firebasestorage.app",
                messagingSenderId: "465781488910",
                appId: "1:465781488910:web:6f9c2b4bc91317a6bbab5f",
                measurementId: "G-4FEDD254GY"
            },
            LIBS: {
                JSPDF: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                DOCX: 'https://unpkg.com/docx@8.2.2/build/index.umd.js'
            }
        };
        // ----------------------------------------------

        // Global variables
        let auth, db, googleProvider;
        let currentUser = null;
        let pendingPlan = null; 
        let authMode = 'login'; // 'login' or 'register'

        // Helper function for Banner
        function closeBanner() {
            const banner = document.getElementById('system-alert-banner');
            const nav = document.getElementById('navbar');
            const appLayout = document.getElementById('pida-app-layout');
            
            banner.classList.add('hidden');
            document.body.style.marginTop = '0px';
            if (nav) nav.style.top = '0px';
            if (appLayout) appLayout.style.top = '0px';
        }

        // Auth Mode Switcher (Login vs Register)
        function switchAuthMode(mode) {
            authMode = mode;
            const btnLogin = document.getElementById('tab-login');
            const btnReg = document.getElementById('tab-register');
            const title = document.getElementById('auth-title');
            const desc = document.getElementById('auth-desc');
            const submitBtn = document.getElementById('auth-submit-btn');
            const googleText = document.getElementById('google-text');
            const errMsg = document.getElementById('login-message');
            
            errMsg.style.display = 'none';

            if (mode === 'login') {
                btnLogin.classList.add('active');
                btnReg.classList.remove('active');
                title.textContent = 'Bienvenido de nuevo';
                desc.textContent = 'Accede para continuar tu investigación.';
                submitBtn.textContent = 'Ingresar';
                googleText.textContent = 'Entrar con Google';
            } else {
                btnLogin.classList.remove('active');
                btnReg.classList.add('active');
                title.textContent = 'Crear una cuenta';
                desc.textContent = 'Únete para acceder a PIDA.';
                submitBtn.textContent = 'Registrarse';
                googleText.textContent = 'Registrarse con Google';
            }
        }

        // Markdown config
        marked.setOptions({ gfm: true, breaks: true, headerIds: false });
        DOMPurify.addHook('afterSanitizeAttributes', function (node) {
            if ('target' in node) { node.setAttribute('target', '_blank'); node.setAttribute('rel', 'noopener noreferrer'); }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const landingRoot = document.getElementById('landing-page-root');
            const loginScreen = document.getElementById('pida-login-screen');
            const appRoot = document.getElementById('pida-app-root');

            // --- LEGAL MODAL LOGIC ---
            const legalBtn = document.getElementById('open-legal-btn');
            const legalModal = document.getElementById('pida-legal-modal');
            if(legalBtn && legalModal){
                legalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    legalModal.classList.remove('hidden');
                });
            }

            // --- TESTIMONIALS CAROUSEL LOGIC ---
            const track = document.getElementById('carouselTrack');
            if (track) {
                const slides = Array.from(track.children);
                const dotsNav = document.getElementById('carouselDots');
                const dots = Array.from(dotsNav.children);
                let currentSlide = 0;

                function updateSlide(index) {
                    track.style.transform = 'translateX(-' + (index * 100) + '%)';
                    dots.forEach(d => d.classList.remove('active'));
                    if(dots[index]) dots[index].classList.add('active');
                    currentSlide = index;
                }

                // Auto rotate
                setInterval(() => {
                    let next = currentSlide + 1;
                    if (next >= slides.length) next = 0;
                    updateSlide(next);
                }, 5000); // 5 seconds

                // Manual dots click
                dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => {
                        updateSlide(index);
                    });
                });
            }

            // --- STRIPE RETURN HANDLER (PRO UX) ---
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment_status');
            
            if (paymentStatus) {
                const banner = document.getElementById('system-alert-banner');
                const bannerText = document.getElementById('system-alert-text');
                
                if (paymentStatus === 'success') {
                    banner.style.backgroundColor = '#10B981'; 
                    bannerText.innerHTML = "¡Suscripción activada! Bienvenido a PIDA.";
                    banner.classList.remove('hidden');
                } else if (paymentStatus === 'canceled') {
                    banner.style.backgroundColor = '#6B7280'; 
                    bannerText.innerText = "El proceso de pago fue cancelado.";
                    banner.classList.remove('hidden');
                } else if (paymentStatus === 'error') {
                    banner.style.backgroundColor = '#EF4444'; 
                    bannerText.innerText = "Hubo un problema con el pago. Intenta de nuevo.";
                    banner.classList.remove('hidden');
                }

                window.history.replaceState({}, document.title, window.location.pathname);
                
                requestAnimationFrame(() => {
                    const h = banner.offsetHeight;
                    document.body.style.marginTop = h + 'px';
                    const nav = document.getElementById('navbar');
                    if(nav) nav.style.top = h + 'px';
                });
                
                setTimeout(() => closeBanner(), 8000);
            }

            // Header Scroll Effect
            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                if (nav) {
                    if (window.scrollY > 20) nav.classList.add('scrolled');
                    else nav.classList.remove('scrolled');
                }
            });

            // 1. Init Firebase
            try {
                if (!firebase.apps.length) firebase.initializeApp(PIDA_CONFIG.FIREBASE);
                auth = firebase.auth();
                db = firebase.firestore();
                googleProvider = new firebase.auth.GoogleAuthProvider();
                googleProvider.setCustomParameters({ prompt: 'select_account' });

                // 2. Alert System
                try {
                    const banner = document.getElementById('system-alert-banner');
                    const bannerText = document.getElementById('system-alert-text');
                    const nav = document.getElementById('navbar');
                    const appLayout = document.getElementById('pida-app-layout');

                    if(banner.classList.contains('hidden')) {
                        db.collection('config').doc('alerts').onSnapshot((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                if (data.active) {
                                    bannerText.textContent = data.message;
                                    if(data.type === 'error') banner.style.backgroundColor = '#EF4444';
                                    else if(data.type === 'info') banner.style.backgroundColor = '#1D3557';
                                    else banner.style.backgroundColor = '#ff9800'; 
                                    
                                    banner.classList.remove('hidden');
                                    requestAnimationFrame(() => {
                                        const height = banner.offsetHeight;
                                        document.body.style.marginTop = height + 'px'; 
                                        if(nav) nav.style.top = height + 'px';
                                        if(appLayout) {
                                            appLayout.style.top = height + 'px';
                                            appLayout.style.height = `calc(100vh - ${height}px)`;
                                        }
                                    });
                                } else {
                                    closeBanner();
                                }
                            }
                        }, (error) => { console.log("Alerts unavailable:", error.code); });
                    }
                } catch (e) { console.warn("Error initiating alerts:", e); }

                // 3. Auth State & Transition Logic (Global Loader)
                const globalLoader = document.getElementById('pida-global-loader');
                
                const hideLoader = () => {
                    if(globalLoader) {
                        globalLoader.classList.add('fade-out');
                        setTimeout(() => {
                            globalLoader.style.display = 'none';
                        }, 600); 
                    }
                };

                auth.onAuthStateChanged(async function (user) {
                    currentUser = user;
                    
                    if (user) {
                        loginScreen.style.display = 'none';
                        
                        // CHECK ACCESS AUTHORIZATION
                        const accessGranted = await checkAccessAuthorization(user);

                        if (accessGranted) {
                            landingRoot.style.display = 'none';
                            appRoot.style.display = 'block';
                            runApp(user); 
                            requestAnimationFrame(() => hideLoader());

                        } else {
                            landingRoot.style.display = 'block';
                            appRoot.style.display = 'none';
                            
                            // Procesar intentos de pago pendientes
                            if (pendingPlan) {
                                startCheckout(STRIPE_ROLE_PRICES[pendingPlan]);
                                pendingPlan = null; 
                            } else {
                                window.location.hash = 'planes';
                            }
                            hideLoader();
                        }
                    } else {
                        landingRoot.style.display = 'block';
                        appRoot.style.display = 'none';
                        hideLoader();
                    }
                });

            } catch (firebaseError) {
                console.error("Critical Firebase Error:", firebaseError);
            }

			// --- ACCESO CHECK FUNCTION (MODIFICADO) ---
			async function checkAccessAuthorization(user) {
    			console.log("Verificando acceso para:", user.email);
    			const headers = await Utils.getHeaders(user);
    			if (!headers) return false;

    			// 1. Verificar Suscripción de Pago (Lógica actual)
    			try {
        			const subscriptionsRef = db.collection('customers')
            			.doc(user.uid)
            			.collection('subscriptions');
        
        			const snapshot = await subscriptionsRef
            			.where('status', 'in', ['active', 'trialing'])
            			.get();

        			if (!snapshot.empty) {
            			console.log("Acceso Concedido: Suscripción activa encontrada.");
            			return true;
        			}
    			} catch (error) {
        			console.error("Error al verificar Stripe:", error);
        			// Continuamos al chequeo VIP/Admin
    			}

    			// 2. Verificar Acceso VIP/Admin (Nueva lógica: Consulta al backend)
    			try {
        			console.log("Verificando acceso VIP/Admin a través de Cloud Run...");
        
        			// Llama al nuevo endpoint
        			const response = await fetch(`${PIDA_CONFIG.API_CHAT}/check-vip-access`, {
            			method: 'POST', 
            			headers: headers
        			});

        			if (!response.ok) {
            			console.error("Fallo la petición VIP:", response.status);
            			// Si el backend responde 401/403, es denegado
            			return false;
        			}

        			const result = await response.json();
        
        			if (result.is_vip_user) {
            			console.log("Acceso Concedido: Usuario VIP/Admin detectado por el backend.");
            			return true;
        			}

    			} catch (error) {
        			console.error("Error durante la verificación VIP:", error);
        			// Si el API falla por conexión, por seguridad, denegamos.
        			return false;
    			}

    			console.log("Acceso Denegado: No se encontró suscripción activa ni estatus VIP/Admin.");
    			return false;
			}

            // 4. UI Handlers (Login)
            document.querySelectorAll('.trigger-login').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (loginScreen) loginScreen.style.display = 'flex';
                    switchAuthMode('login'); // Reset to login default
                });
            });

            // HANDLE AUTH FORM (Login / Register explicit)
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                const btn = e.target.querySelector('button');
                const msg = document.getElementById('login-message');
                
                msg.style.display = 'none';
                btn.disabled = true;
                
                try {
                    if (authMode === 'login') {
                        btn.textContent = 'Verificando...';
                        await auth.signInWithEmailAndPassword(email, pass);
                    } else {
                        btn.textContent = 'Creando cuenta...';
                        await auth.createUserWithEmailAndPassword(email, pass);
                    }
                    // Success is handled by onAuthStateChanged
                } catch (error) {
                    btn.disabled = false;
                    msg.style.display = 'block';
                    
                    if (authMode === 'login') {
                        btn.textContent = 'Ingresar';
                        
                        // Si el error es explícitamente una contraseña incorrecta (o la combinación genérica que Firebase usa para eso)
                        if (error.code === 'auth/wrong-password') {
                            msg.textContent = "Contraseña incorrecta. Intenta de nuevo.";
                        } 
                        // Para CUALQUIER OTRA FALLA DE LOGIN (user-not-found, invalid-credential, etc.), 
                        // asumimos que el usuario no existe y lo enviamos a registrarse.
                        else {
                            // 1. Cambiamos la pestaña a 'Crear Cuenta'
                            switchAuthMode('register');
                            // 2. Mostramos un mensaje claro para que complete el registro
                            msg.textContent = "¡Bienvenido! No encontramos tu cuenta. Por favor, regístrate para acceder a los planes.";
                        }
                    } else { // authMode === 'register'
                        btn.textContent = 'Registrarse';
                        
                        // Si el email ya existe al intentar REGISTRARSE:
                        if (error.code === 'auth/email-already-in-use') {
                            // 1. Cambiamos la pestaña a 'Ingresar'
                            switchAuthMode('login');
                            // 2. Mostramos un mensaje para que inicie sesión
                            msg.textContent = "Ya tienes una cuenta registrada. Por favor, ingresa tu contraseña para acceder.";
                        } 
                        // Manejo de contraseña débil
                        else if (error.code === 'auth/weak-password') {
                            msg.textContent = "La contraseña es muy débil (mínimo 6 caracteres).";
                        } 
                        // Otros errores de registro
                        else {
                            msg.textContent = "Error al crear cuenta: " + error.message;
                        }
                    }
                }
            });

            document.getElementById('google-login-btn').addEventListener('click', async () => {
                const msg = document.getElementById('login-message');
                msg.style.display = 'none';
                try { await auth.signInWithPopup(googleProvider); } 
                catch (error) { msg.style.display = 'block'; msg.textContent = "Error Google: " + error.message; }
            });

            // 5. CHECKOUT LOGIC (STRIPE EXTENSION - PRO VERSION)
            async function startCheckout(priceId) {
                if (!currentUser) {
                    loginScreen.style.display = 'flex';
                    switchAuthMode('register'); // Encourage signup for purchase
                    return;
                }
                
                const banner = document.getElementById('system-alert-banner');
                const bannerText = document.getElementById('system-alert-text');
                
                try {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const successUrl = `${baseUrl}?payment_status=success`;
                    const cancelUrl = `${baseUrl}?payment_status=canceled`;

                    const docRef = await db.collection('customers')
                        .doc(currentUser.uid)
                        .collection('checkout_sessions')
                        .add({
                            price: priceId,
                            success_url: successUrl,
                            cancel_url: cancelUrl,
                            allow_promotion_codes: true,
                            metadata: { source: 'web_app_v7' }
                        });

                    docRef.onSnapshot((snap) => {
                        const { error, url } = snap.data();
                        
                        if (error) {
                            banner.style.backgroundColor = '#EF4444';
                            bannerText.innerText = `Error de facturación: ${error.message}`;
                            banner.classList.remove('hidden');
                            document.querySelectorAll('.plan-cta').forEach(b => {
                                b.textContent = b.getAttribute('data-original-text') || 'Elegir';
                                b.style.pointerEvents = "auto";
                                b.style.opacity = "1";
                            });
                        }
                        
                        if (url) {
                            window.location.assign(url);
                        }
                    });
                } catch (error) {
                    console.error("Checkout Error:", error);
                    banner.style.backgroundColor = '#EF4444';
                    bannerText.innerText = "Error de conexión. Verifica tu internet.";
                    banner.classList.remove('hidden');
                }
            }

            // Attach Checkout Logic to Plan Buttons (Enhanced)
            document.querySelectorAll('.plan-cta').forEach(btn => {
                btn.setAttribute('data-original-text', btn.textContent);
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const planKey = btn.getAttribute('data-plan');
                    
                    // Nota: Si quieres mantener el flujo de correo para Corp, descomenta esto.
                    // Pero como diste un ID, asumo que quieres cobrarlo.
                    /* 
                    if (planKey === 'corp') {
                        window.location.href = "mailto:contacto@pida-ai.com?subject=Interés%20Plan%20Corporativo%20PIDA";
                        return;
                    } 
                    */

                    if (currentUser) {
                        if (STRIPE_ROLE_PRICES[planKey]) {
                            btn.textContent = "Iniciando Stripe...";
                            btn.style.opacity = "0.7";
                            btn.style.pointerEvents = "none";
                            
                            startCheckout(STRIPE_ROLE_PRICES[planKey]);
                            
                            // Timeout de seguridad (10s)
                            setTimeout(() => {
                                btn.textContent = btn.getAttribute('data-original-text');
                                btn.style.opacity = "1";
                                btn.style.pointerEvents = "auto";
                            }, 10000);
                        } else {
                            console.error("Price ID not configured for:", planKey);
                        }
                    } else {
                        pendingPlan = planKey;
                        loginScreen.style.display = 'flex';
                        // Switch to register mode automatically if buying
                        switchAuthMode('register');
                    }
                });
            });

            // --- APP LOGIC START (Restored) ---
            const Utils = {
                async loadScript(src) {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector(`script[src="${src}"]`)) return resolve();
                        const s = document.createElement('script'); s.src = src; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
                    });
                },
                sanitize(html) { return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html; },
                getTimestampedFilename(title) { const now=new Date(); return `${(title||"Doc").replace(/[^a-zA-Z0-9]/g,"")}_${now.getTime()}`; },
                getRawText(html) { const t=document.createElement('div'); t.innerHTML=html; return t.innerText||""; },
                
                // --- FIX CRÍTICO V7.4: Content-Type Header ---
                async getHeaders(user) { 
                    try { 
                        const t = await user.getIdToken(); 
                        return { 
                            'Authorization': 'Bearer ' + t,
                            'Content-Type': 'application/json' 
                        }; 
                    } catch { return null; } 
                }
            };

            const Exporter = {
                async downloadPDF(fname, title, content) { await Utils.loadScript(PIDA_CONFIG.LIBS.JSPDF); const doc=new window.jspdf.jsPDF(); doc.text(title,10,10); doc.save(fname+".pdf"); },
                async downloadDOCX(fname, title, content) { await Utils.loadScript(PIDA_CONFIG.LIBS.DOCX); const {Document,Packer,Paragraph,TextRun}=window.docx; const doc=new Document({sections:[{children:[new Paragraph({children:[new TextRun(title)]}) ]}]}); Packer.toBlob(doc).then(b=>{const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=fname+".docx";a.click();}); },
                downloadTXT(fname, title, content) { let t=title+"\n"; content.forEach(c=>{t+=`[${c.role}]: ${c.content}\n`}); const b=new Blob([t]); const u=URL.createObjectURL(b); const a=document.createElement('a');a.href=u;a.download=fname+".txt";a.click(); }
            };

            function runApp(user) {
                const dom = {
                    navInv: document.getElementById('nav-investigador'),
                    navAna: document.getElementById('nav-analizador'),
                    viewInv: document.getElementById('view-investigador'),
                    viewAna: document.getElementById('view-analizador'),
                    viewAcc: document.getElementById('view-account'),
                    chatBox: document.getElementById('pida-chat-box'),
                    input: document.getElementById('pida-input'),
                    sendBtn: document.getElementById('pida-send-btn'),
                    pName: document.getElementById('pida-profile-name'),
                    pEmail: document.getElementById('pida-profile-email'),
                    pAvatar: document.getElementById('pida-profile-avatar'),
                    pLogout: document.getElementById('pida-profile-logout'),
                    anaInput: document.getElementById('analyzer-file-upload'),
                    anaFiles: document.getElementById('active-files-area'),
                    anaBtn: document.getElementById('analyze-btn'),
                    anaResBox: document.getElementById('analyzer-results-section'),
                    anaLoader: document.getElementById('analyzer-loader-container'),
                    anaResTxt: document.getElementById('analyzer-analysis-result'),
                    anaControls: document.getElementById('analyzer-download-controls'),
                    anaInst: document.getElementById('user-instructions'),
                    analyzerClearBtn: document.getElementById('analyzer-clear-btn'),
                    accBilling: document.getElementById('acc-billing-btn'),
                    accUpdate: document.getElementById('acc-update-btn'),
                    accFirst: document.getElementById('acc-firstname'),
                    accLast: document.getElementById('acc-lastname'),
                    accReset: document.getElementById('acc-reset-btn'),
                    accNotify: document.getElementById('account-notification-area'),
                    chatClearBtn: document.getElementById('chat-clear-btn'),
                    newChatBtn: document.getElementById('pida-new-chat-btn'),
                    historyList: document.getElementById('pida-history-list'),
                    historyBtn: document.getElementById('history-dropdown-btn'),
                    historyContent: document.getElementById('history-dropdown-content'),
                    anaUpload: document.getElementById('analyzer-upload-btn'),
                    anaHistBtn: document.getElementById('analyzer-history-dropdown-btn'),
                    anaHistContent: document.getElementById('analyzer-history-dropdown-content'),
                    anaHistList: document.getElementById('analyzer-history-list'),
                    dlChatPdf: document.getElementById('chat-download-pdf-btn'),
                    dlChatDoc: document.getElementById('chat-download-docx-btn'),
                    dlChatTxt: document.getElementById('chat-download-txt-btn'),
                    dlAnaPdf: document.getElementById('analyzer-download-pdf-btn'),
                    dlAnaDoc: document.getElementById('analyzer-download-docx-btn'),
                    dlAnaTxt: document.getElementById('analyzer-download-txt-btn'),
                    sidebarUser: document.getElementById('sidebar-user-info-click')
                };

                let state = { currentView: 'investigador', conversations: [], currentChat: { id: null, title: '', messages: [] }, anaFiles: [], anaText: "", anaHistory: [] };

                dom.pName.textContent = user.displayName || 'Usuario';
                dom.pEmail.textContent = user.email;
                dom.pAvatar.src = user.photoURL || 'img/PIDA_logo-P3-80.png';
                
                dom.pLogout.onclick = () => {
                    auth.signOut().then(() => {
                        document.getElementById('pida-app-root').style.display = 'none';
                        document.getElementById('landing-page-root').style.display = 'block';
                        window.scrollTo(0,0);
                        currentUser = null;
                    });
                };
                
                document.getElementById('app-home-link').onclick = (e) => { e.preventDefault(); setView('investigador'); };

                function setView(view) {
                    state.currentView = view;
                    dom.navInv.classList.toggle('active', view === 'investigador');
                    dom.navAna.classList.toggle('active', view === 'analizador');
                    dom.viewInv.classList.toggle('hidden', view !== 'investigador');
                    dom.viewAna.classList.toggle('hidden', view !== 'analizador');
                    dom.viewAcc.classList.toggle('hidden', view !== 'cuenta');
                    document.getElementById('chat-controls').classList.toggle('hidden', view !== 'investigador');
                    document.getElementById('analyzer-controls').classList.toggle('hidden', view !== 'analizador');
                    document.getElementById('account-controls').classList.toggle('hidden', view !== 'cuenta');
                    if (view === 'investigador') loadChatHistory();
                    if (view === 'analizador') loadAnaHistory();
                }

                dom.navInv.onclick = () => setView('investigador');
                dom.navAna.onclick = () => setView('analizador');
                dom.sidebarUser.onclick = () => setView('cuenta');
                dom.pAvatar.onclick = () => setView('cuenta');

                function toggleDrop(content) {
                    const show = content.classList.contains('show');
                    dom.historyContent.classList.remove('show');
                    dom.anaHistContent.classList.remove('show');
                    if (!show) content.classList.add('show');
                }
                dom.historyBtn.onclick = (e) => { e.stopPropagation(); toggleDrop(dom.historyContent); };
                dom.anaHistBtn.onclick = (e) => { e.stopPropagation(); toggleDrop(dom.anaHistContent); };
                window.onclick = () => { dom.historyContent.classList.remove('show'); dom.anaHistContent.classList.remove('show'); };

                function renderChat(msg) {
                    const d = document.createElement('div');
                    d.className = `pida-bubble ${msg.role === 'user' ? 'user-message-bubble' : 'pida-message-bubble'}`;
                    
                    let safeContent = msg.content;
                    if (msg.role === 'model') {
                        // FIX ASTERISCOS
                        safeContent = safeContent.replace(/(?:[\n\r\s]*)(?:\*\*|__)?(Fuente:)(?:\*\*|__)?/g, '\n\n<hr>\n\n<strong>$1</strong>');
                    }
                    
                    d.innerHTML = Utils.sanitize(marked.parse(safeContent));
                    dom.chatBox.appendChild(d);
                    if (msg.role === 'model') renderFollowUpQuestions(d);
                    dom.chatBox.parentElement.scrollTop = dom.chatBox.parentElement.scrollHeight;
                    return d;
                }

                function renderFollowUpQuestions(messageElement) {
                    const headings = Array.from(messageElement.querySelectorAll("h2, h3"));
                    const followUpHeading = headings.find(h => h.textContent.includes("Preguntas de Seguimiento"));
                    if (followUpHeading) {
                        const list = followUpHeading.nextElementSibling;
                        if (list && (list.tagName === "UL" || list.tagName === "OL")) {
                            const questions = Array.from(list.querySelectorAll("li"));
                            const card = document.createElement("div");
                            card.className = "follow-up-card";
                            card.innerHTML = "<h3>Preguntas de seguimiento:</h3>";
                            questions.forEach(q => {
                                const btn = document.createElement("button");
                                btn.className = "follow-up-btn";
                                btn.textContent = q.textContent;
                                btn.onclick = () => { dom.input.value = q.textContent; sendChat(); };
                                card.appendChild(btn);
                            });
                            followUpHeading.remove(); list.remove(); messageElement.appendChild(card);
                        }
                    }
                }

                // --- REAL CHAT LOGIC ---
                async function loadChatHistory() {
                    const h = await Utils.getHeaders(user);
                    if (!h) return;
                    try {
                        const r = await fetch(`${PIDA_CONFIG.API_CHAT}/conversations`, { headers: h });
                        state.conversations = await r.json();
                        dom.historyList.innerHTML = '';
                        state.conversations.forEach(c => {
                            const item = document.createElement('div');
                            item.className = `pida-history-item ${c.id === state.currentChat.id ? 'active' : ''}`;
                            const titleSpan = document.createElement('span');
                            titleSpan.className = 'pida-history-item-title';
                            titleSpan.textContent = c.title;
                            titleSpan.style.flex = "1";
                            titleSpan.onclick = (e) => { e.stopPropagation(); loadChat(c.id); toggleDrop(dom.historyContent); };
                            const delBtn = document.createElement('button');
                            delBtn.className = 'delete-icon-btn';
                            delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                            delBtn.onclick = async (e) => {
                                e.stopPropagation();
                                await fetch(`${PIDA_CONFIG.API_CHAT}/conversations/${c.id}`, { method: 'DELETE', headers: h });
                                if (state.currentChat.id === c.id) {
                                    state.currentChat = { id: null, title: '', messages: [] };
                                    dom.chatBox.innerHTML = '';
                                }
                                loadChatHistory();
                            };
                            item.appendChild(titleSpan);
                            item.appendChild(delBtn);
                            dom.historyList.appendChild(item);
                        });
                        if (!state.currentChat.id && state.conversations.length) loadChat(state.conversations[0].id);
                    } catch (e) { console.error(e); }
                }

                async function loadChat(id) {
                    const h = await Utils.getHeaders(user);
                    const r = await fetch(`${PIDA_CONFIG.API_CHAT}/conversations/${id}/messages`, { headers: h });
                    const msgs = await r.json();
                    const c = state.conversations.find(x => x.id === id);
                    state.currentChat = { id, title: c?.title, messages: msgs };
                    dom.chatBox.innerHTML = '';
                    msgs.forEach(renderChat);
                    loadChatHistory();
                }

                async function sendChat() {
                    const txt = dom.input.value.trim();
                    if (!txt) return;
                    if (!state.currentChat.id) await handleNewChat(false);
                    renderChat({ role: 'user', content: txt });
                    state.currentChat.messages.push({ role: 'user', content: txt });
                    dom.input.value = '';
                    
                    const botBubble = document.createElement('div');
                    botBubble.className = 'pida-bubble pida-message-bubble';
                    botBubble.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
                    dom.chatBox.appendChild(botBubble);
                    dom.chatBox.parentElement.scrollTop = dom.chatBox.parentElement.scrollHeight;

                    try {
                        const h = await Utils.getHeaders(user);
                        const r = await fetch(`${PIDA_CONFIG.API_CHAT}/chat-stream/${state.currentChat.id}`, {
                            method: 'POST', headers: h, body: JSON.stringify({ prompt: txt })
                        });
                        const reader = r.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = "";
                        let isFirstChunk = true;
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n\n');
                            for (const l of lines) {
                                if (l.startsWith('data:')) {
                                    try {
                                        const d = JSON.parse(l.substring(6));
                                        if (d.text) {
                                            if (isFirstChunk) { botBubble.innerHTML = ''; isFirstChunk = false; }
                                            fullText += d.text;
                                            // Render streaming markdown
                                            let safeContent = fullText.replace(/(?:[\n\r\s]*)(?:\*\*|__)?(Fuente:)(?:\*\*|__)?/g, '\n\n<hr>\n\n<strong>$1</strong>');
                                            botBubble.innerHTML = Utils.sanitize(marked.parse(safeContent));
                                            dom.chatBox.parentElement.scrollTop = dom.chatBox.parentElement.scrollHeight;
                                        }
                                    } catch (e) { }
                                }
                            }
                        }
                        state.currentChat.messages.push({ role: 'model', content: fullText });
                        renderFollowUpQuestions(botBubble);
                        if (state.currentChat.messages.length === 2) {
                            const t = txt.substring(0, 30);
                            await fetch(`${PIDA_CONFIG.API_CHAT}/conversations/${state.currentChat.id}/title`, {
                                method: 'PATCH', headers: h, body: JSON.stringify({ title: t })
                            });
                            loadChatHistory();
                        }
                    } catch (error) {
                        botBubble.innerHTML = "<span style='color:red'>Error de conexión. Intente nuevamente.</span>";
                    }
                }

                async function handleNewChat(clearUI = true) {
                    if (clearUI) { dom.chatBox.innerHTML = ''; dom.input.value = ''; }
                    const h = await Utils.getHeaders(user);
                    try {
                        const r = await fetch(`${PIDA_CONFIG.API_CHAT}/conversations`, {
                            method: 'POST', headers: h, body: JSON.stringify({ title: "Nuevo Chat" })
                        });
                        const newConvo = await r.json();
                        state.conversations.unshift(newConvo);
                        state.currentChat = { id: newConvo.id, title: newConvo.title, messages: [] };
                        loadChatHistory();
                        if (clearUI) {
                            const sysMsg = document.createElement('div');
                            sysMsg.style.textAlign = 'center'; sysMsg.style.color = '#999'; sysMsg.style.margin = '20px 0'; sysMsg.style.fontSize = '0.85rem';
                            sysMsg.innerText = 'Nueva conversación iniciada';
                            dom.chatBox.appendChild(sysMsg);
                        }
                    } catch (e) { console.error(e); }
                }

                dom.sendBtn.onclick = (e) => { e.preventDefault(); sendChat(); };
                dom.input.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } };
                dom.newChatBtn.onclick = () => handleNewChat(true);
                dom.chatClearBtn.onclick = () => handleNewChat(true);
                
                // --- REAL ANALYZER LOGIC ---
                dom.anaUpload.onclick = () => dom.anaInput.click();
                dom.anaInput.onchange = (e) => { state.anaFiles.push(...e.target.files); renderFiles(); };

                function renderFiles() {
                    dom.anaFiles.innerHTML = '';
                    state.anaFiles.forEach((f, i) => {
                        const d = document.createElement('div');
                        d.className = 'active-file-chip';
                        d.innerHTML = `<span>${f.name}</span> <button>×</button>`;
                        d.querySelector('button').onclick = () => { state.anaFiles.splice(i, 1); renderFiles(); };
                        dom.anaFiles.appendChild(d);
                    });
                }

                async function analyze() {
                    if (!state.anaFiles.length) return;
                    dom.anaResBox.style.display = 'block';
                    dom.anaLoader.style.display = 'block';
                    
                    // Ocultar resultado inicialmente mientras carga
                    document.getElementById('analyzer-response-container').style.display = 'none';
                    
                    dom.anaResTxt.innerHTML = ''; 
                    dom.anaControls.style.display = 'none';
                    const fd = new FormData();
                    state.anaFiles.forEach(f => fd.append('files', f));
                    fd.append('instructions', dom.anaInst.value);
                    const h = await Utils.getHeaders(user, null);
                    try {
                        const r = await fetch(`${PIDA_CONFIG.API_ANA}/analyze/`, {
                            method: 'POST', headers: { 'Authorization': h['Authorization'] }, body: fd
                        });
                        if (!r.ok) throw new Error("Error en la petición");
                        const reader = r.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = "";
                        let isFirstChunk = true;
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n\n');
                            for (const line of lines) {
                                if (line.startsWith('data:')) {
                                    try {
                                        const data = JSON.parse(line.substring(5).trim());
                                        if (data.text) {
                                            if (isFirstChunk) { 
                                                dom.anaLoader.style.display = 'none'; 
                                                // Mostrar contenedor de respuesta al recibir primer chunk
                                                document.getElementById('analyzer-response-container').style.display = 'block';
                                                isFirstChunk = false; 
                                            }
                                            fullText += data.text;
                                            dom.anaResTxt.innerHTML = Utils.sanitize(marked.parse(fullText));
                                            
                                            // AUTOSCROLL CORREGIDO
                                            const scrollContainer = dom.viewAna.querySelector('.pida-view-content');
                                            scrollContainer.scrollTop = scrollContainer.scrollHeight;
                                        }
                                        if (data.done) {
                                            state.anaText = fullText;
                                            dom.anaControls.style.display = 'flex';
                                            loadAnaHistory();
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        dom.anaLoader.style.display = 'none';
                        document.getElementById('analyzer-response-container').style.display = 'block';
                        dom.anaResTxt.innerHTML = `<span style='color:red'>Error al analizar: ${e.message}</span>`;
                    }
                }

                dom.anaBtn.onclick = analyze;
                dom.analyzerClearBtn.onclick = () => {
                    state.anaFiles = []; state.anaText = ""; renderFiles();
                    dom.anaInst.value = ''; dom.anaResBox.style.display = 'none'; dom.anaControls.style.display = 'none';
                };

                async function loadAnaHistory() {
                    const h = await Utils.getHeaders(user);
                    const r = await fetch(`${PIDA_CONFIG.API_ANA}/analysis-history/`, { headers: h });
                    state.anaHistory = await r.json();
                    dom.anaHistList.innerHTML = '';
                    state.anaHistory.forEach(a => {
                        const item = document.createElement('div');
                        item.className = 'pida-history-item';
                        const titleSpan = document.createElement('span');
                        titleSpan.className = 'pida-history-item-title';
                        titleSpan.textContent = a.title;
                        titleSpan.style.flex = "1";
                        titleSpan.onclick = async (e) => {
                            e.stopPropagation();
                            const r2 = await fetch(`${PIDA_CONFIG.API_ANA}/analysis-history/${a.id}`, { headers: h });
                            const d2 = await r2.json();
                            state.anaText = d2.analysis;
                            dom.anaResTxt.innerHTML = Utils.sanitize(marked.parse(d2.analysis));
                            dom.anaLoader.style.display = 'none';
                            
                            // Mostrar contenedor al cargar historial
                            document.getElementById('analyzer-response-container').style.display = 'block';
                            
                            dom.anaResBox.style.display = 'block';
                            dom.anaControls.style.display = 'flex';
                            toggleDrop(dom.anaHistContent);
                        };
                        const delBtn = document.createElement('button');
                        delBtn.className = 'delete-icon-btn';
                        delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                        delBtn.onclick = async (e) => {
                            e.stopPropagation();
                            await fetch(`${PIDA_CONFIG.API_ANA}/analysis-history/${a.id}`, { method: 'DELETE', headers: h });
                            loadAnaHistory();
                        };
                        item.appendChild(titleSpan);
                        item.appendChild(delBtn);
                        dom.anaHistList.appendChild(item);
                    });
                }

				//Enviar email de restablecimiento de contraseña
				dom.accReset.onclick = () => {
    				if (confirm("¿Enviar correo para restablecer contraseña a " + user.email + "?")) {
        				auth.sendPasswordResetEmail(user.email)
            				.then(() => {
                				alert("✅ Correo enviado. Revisa tu bandeja de entrada (y spam).");
           				 	})
            					.catch((error) => {
               				 		console.error(error);
                					alert("❌ Error: " + error.message);
           				 	});
    				}
				};

				// ============================================================
                // LOGICA DESCARGA DE CHAT USANDO EL BACKEND (PDF/DOCX)
                // ============================================================
                
                async function downloadChatFromBackend(format) {
                    // 1. Verificar si hay mensajes
                    if (!state.currentChat || !state.currentChat.messages || state.currentChat.messages.length === 0) {
                        return alert("No hay conversación para descargar.");
                    }

                    const btn = format === 'pdf' ? dom.dlChatPdf : dom.dlChatDoc;
                    const originalText = btn.textContent;
                    btn.textContent = "Generando...";
                    btn.disabled = true;

                    try {
                        // 2. Convertir el array de mensajes a texto plano con formato para el backend
                        let chatContent = "";
                        state.currentChat.messages.forEach(msg => {
                            const role = msg.role === 'user' ? 'Usuario' : 'PIDA';
                            // Limpiamos contenido
                            let cleanContent = msg.content || "";
                            chatContent += `**${role}**:\n${cleanContent}\n\n`;
                        });

                        const title = state.currentChat.title || "Historial de Chat";

                        // 3. Preparar envío al Backend
                        const fd = new FormData();
                        fd.append('chat_text', chatContent);
                        fd.append('title', title);
                        fd.append('file_format', format); // 'pdf' o 'docx'

                        // Obtener token de seguridad
                        let token = "";
                        if (auth.currentUser) {
                            token = await auth.currentUser.getIdToken();
                        }

                        // 4. Llamada al Backend
                        const response = await fetch(`${PIDA_CONFIG.API_CHAT}/download-chat`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': 'Bearer ' + token
                            },
                            body: fd
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`Error del servidor: ${errText}`);
                        }

                        // 5. Descargar el archivo generado
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        
                        // Obtener nombre del archivo del header o generarlo
                        const contentDisp = response.headers.get('Content-Disposition');
                        let fileName = `PIDA_Chat_${new Date().getTime()}.${format}`;
                        if (contentDisp && contentDisp.includes('filename=')) {
                            fileName = contentDisp.split('filename=')[1].replace(/['"]/g, '');
                        }
                        
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);

                    } catch (e) {
                        console.error("Error descarga chat:", e);
                        alert("Error al generar el documento: " + e.message);
                    } finally {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                }

                // Asignar los botones a la nueva función corregida (PDF y DOCX van al Backend)
                dom.dlChatPdf.onclick = () => downloadChatFromBackend('pdf');
                dom.dlChatDoc.onclick = () => downloadChatFromBackend('docx');
                
                // El TXT lo mantenemos local (re-escrito aquí) porque es simple y funciona
                dom.dlChatTxt.onclick = () => { 
                    const t = state.currentChat.title || "Chat"; 
                    Exporter.downloadTXT(Utils.getTimestampedFilename(t), t, state.currentChat.messages); 
                };

				
				// ============================================================
                // LÓGICA DE DESCARGA ANALISIS DESDE EL BACKEND
                // ============================================================
                
                async function downloadAnalysisFromBackend(format) {
                    if (!state.anaText) return alert("No hay análisis para descargar.");
                    
                    const btn = format === 'pdf' ? dom.dlAnaPdf : dom.dlAnaDoc;
                    const originalText = btn.textContent;
                    btn.textContent = "Generando...";
                    btn.disabled = true;

                    try {
                        // 1. Preparamos los datos
                        const fd = new FormData();
                        fd.append('analysis_text', state.anaText);
                        // Usamos las instrucciones del usuario o un título genérico
                        fd.append('instructions', dom.anaInst.value || "Resultados del Análisis");
                        fd.append('file_format', format); // 'pdf' o 'docx'

                        // 2. Obtenemos el token de seguridad
                        const token = await currentUser.getIdToken();
                        
                        // 3. Solicitamos el archivo al Backend (Python)
                        const response = await fetch(`${PIDA_CONFIG.API_ANA}/download-analysis`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': 'Bearer ' + token
                            },
                            body: fd
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`Error del servidor: ${errText}`);
                        }

                        // 4. Convertimos la respuesta en descarga
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        
                        // Intentar obtener el nombre del archivo correcto
                        const contentDisp = response.headers.get('Content-Disposition');
                        let fileName = `PIDA_Analisis_${new Date().getTime()}.${format}`;
                        if (contentDisp && contentDisp.includes('filename=')) {
                            fileName = contentDisp.split('filename=')[1].replace(/['"]/g, '');
                        }
                        
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);

                    } catch (e) {
                        console.error(e);
                        alert("Error al descargar: " + e.message);
                    } finally {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                }

                // Asignamos los botones a la nueva función
                dom.dlAnaPdf.onclick = () => downloadAnalysisFromBackend('pdf');
                dom.dlAnaDoc.onclick = () => downloadAnalysisFromBackend('docx');

                // Lógica mejorada para TXT (Local)
                dom.dlAnaTxt.onclick = () => {
                    if (!state.anaText) return;
                    const content = `INSTRUCCIONES:\n${dom.anaInst.value}\n\n----------------\nANÁLISIS:\n\n${state.anaText}`;
                    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = Utils.getTimestampedFilename("Analisis") + ".txt";
                    a.click();
                };
				
				// LÓGICA PARA ACTUALIZAR NOMBRE (VERSIÓN SILENCIOSA)
				dom.accUpdate.onclick = async () => {
    				const firstName = dom.accFirst.value.trim();
    				const lastName = dom.accLast.value.trim();
    
    				// Función auxiliar para mostrar notificaciones suaves en el área designada
    				const showQuietNotification = (msg, type) => {
        				// type puede ser 'success' (verde) o 'error' (rojo)
        				dom.accNotify.innerHTML = `<div class="pida-notification ${type}">${msg}</div>`;
        				// El mensaje desaparece solo a los 3 segundos
        				setTimeout(() => {
            				dom.accNotify.innerHTML = '';
        				}, 3000);
    				};

    				if (!firstName && !lastName) {
        				showQuietNotification("Ingresa un nombre para actualizar.", "error");
        				return;
    				}

    				const newDisplayName = `${firstName} ${lastName}`.trim();
    				const originalText = dom.accUpdate.textContent;
    
    				// Feedback visual sutil en el botón
    				dom.accUpdate.textContent = "Guardando...";
    				dom.accUpdate.disabled = true;

    				try {
        				// 1. Actualizar en Firebase Auth
        				await user.updateProfile({
            				displayName: newDisplayName
        				});

        				// 2. Actualizar UI inmediata
        				dom.pName.textContent = newDisplayName;
        
        				// 3. Notificación tranquila (barra verde integrada)
        				showQuietNotification("Nombre actualizado correctamente.", "success");
        
    				} catch (error) {
        				console.error("Error:", error);
        				// Notificación de error tranquila (barra roja integrada)
        				showQuietNotification("No se pudo actualizar. Intenta de nuevo.", "error");
    				} finally {
        				// Restaurar botón
        				dom.accUpdate.textContent = originalText;
        				dom.accUpdate.disabled = false;
    				}
				};
				
                // Billing Portal Logic
                 dom.accBilling.onclick = async () => {
                    dom.accBilling.innerText = "Cargando...";
                    try {
                        const fn = firebase.functions().httpsCallable('ext-firestore-stripe-payments-createPortalLink');
                        const { data } = await fn({ returnUrl: window.location.href });
                        window.location.assign(data.url);
                    } catch { alert('Error conectando a Stripe'); dom.accBilling.innerText = "Portal de Facturación"; }
                };
                
                setView('investigador');
            }
        });
    </script>
</body>
</html>
